# 핸드오프 - 2026-01-26 P14g

## 빌드 상태
- 타입 체크: ✅ 통과
- 빌드: ✅ 성공
- 린트: ⚠️ (미확인)

---

## 완료 작업: 이미지 생성 로직 교체

### 변경 내용

원본 FlowStudio 프로젝트의 이미지 생성 로직을 FlowStudio_re에 적용 완료.

#### 핵심 변경사항

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 패키지 | `@google/generative-ai` | `@google/genai` |
| API 호출 | `model.generateContent()` | `ai.models.generateContent()` |
| 모델 | `gemini-2.0-flash-exp-image-generation` | `gemini-3-pro-image-preview` |
| OpenRouter API | images/generations | chat/completions |
| 프로바이더 전략 | google only | google/openrouter hybrid 지원 |

### 수정/생성된 파일

1. **`lib/imageProvider/vertexai.ts`** (신규 생성)
   - `@google/genai` 기반 GenAI 클라이언트
   - Google AI Studio / Vertex AI 듀얼 모드 지원
   - `getGenAIClient()` 싱글톤 함수
   - `VERTEX_AI_MODELS` 상수 (gemini-3-pro-image-preview 등)

2. **`lib/imageProvider/googleGenAI.ts`** (전면 수정)
   - vertexai.ts의 클라이언트 사용
   - `ai.models.generateContent()` API 호출 방식
   - imageConfig로 aspectRatio, imageSize 설정

3. **`lib/imageProvider/openRouter.ts`** (전면 수정)
   - `/api/v1/chat/completions` API 사용
   - `modalities: ['image', 'text']` 설정
   - `image_config` 파라미터 지원
   - Gemini 모델 (`google/gemini-3-pro-image-preview`) 기본 사용

4. **`lib/imageProvider/types.ts`** (확장)
   - 새 모델 타입 추가 (gemini-3-pro-image-preview 등)
   - `GenerationOptions`에 이미지 편집 옵션 추가:
     - `sourceImage`, `refImage`, `refImages`
     - `logoImage`, `maskImage`, `mode`

5. **`lib/imageProvider/selectProvider.ts`** (업데이트)
   - OPENROUTER_GEMINI_CONFIG import 추가
   - PROVIDER_CONFIGS에 새 모델 매핑 추가

### 설치된 패키지

```bash
npm install @google/genai
```

### 환경 변수 (변경 없음)

```env
GOOGLE_API_KEY=...
GOOGLE_GENAI_USE_VERTEXAI=false
OPENROUTER_API_KEY=...
```

---

## 테스트 방법

1. 워크플로우 진입 (업종 선택 → 스타일 선택 → 입력)
2. "생성" 버튼 클릭
3. 서버 로그에서 확인:
   - `POST /api/workflows/session 201` ✅
   - `PUT /api/workflows/session 200` ✅
   - `POST /api/generate 200` ← 이미지 생성 성공 여부
4. 결과 페이지에서 이미지 표시 확인

### 예상 로그 (성공 시)

```
[GoogleGenAI] Generating 1 image(s) with model: gemini-3-pro-image-preview
[GoogleGenAI] ✅ Image 1/1 generated successfully
```

또는 (OpenRouter 사용 시)

```
[OpenRouter] Generating 1 image(s) with model: google/gemini-3-pro-image-preview
[OpenRouter] ✅ Image 1/1 generated successfully
```

---

## 아키텍처 요약

```
lib/imageProvider/
├── vertexai.ts           # @google/genai 클라이언트 (싱글톤)
├── googleGenAI.ts        # Google 프로바이더 (vertexai 사용)
├── openRouter.ts         # OpenRouter 프로바이더 (chat/completions API)
├── selectProvider.ts     # 프로바이더 선택 로직
├── generate.ts           # 통합 생성 함수
├── types.ts              # 타입 정의
├── upscale.ts            # 업스케일 기능
└── index.ts              # 배럴 파일
```

---

## 다음 작업

1. **실제 이미지 생성 테스트**
   - `npm run dev` 실행
   - 워크플로우 완료 후 이미지 생성 확인

2. **환경 변수 확인**
   - GOOGLE_API_KEY가 올바른지 확인
   - API 키가 이미지 생성 권한이 있는지 확인

3. **에러 발생 시**
   - 서버 로그 확인
   - OpenRouter로 fallback 테스트

---

## 참조 문서

- **원본 프로젝트**: `/Users/jerome/dev/FlowStudio`
- **태스크**: `claudedocs/TASK_FLOWSTUDIO.md`
- **이전 핸드오프**: `claudedocs/HANDOFF_2026-01-26_P14f.md`

---

> **마지막 업데이트**: 2026-01-26 이미지 생성 로직 교체 완료
