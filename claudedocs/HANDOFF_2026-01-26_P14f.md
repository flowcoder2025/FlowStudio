# 핸드오프 - 2026-01-26 P14f

## 빌드 상태
- 타입 체크: ✅
- 빌드: ✅
- 린트: ⚠️ (미확인)

## 현재 작업: 워크플로우 이미지 생성 버그 수정

### 문제 상황
워크플로우 마지막에 "생성" 버튼 클릭 시 모달만 닫히고 이미지 생성이 안 됨

### 원인 분석 완료
1. **세션만 생성하고 실제 이미지 생성 API 호출 안 함**
   - `handleGenerate` 함수가 `/api/workflows/session` POST만 하고 끝남
   - `/api/generate` 호출이 누락됨

2. **URL 파라미터 불일치**
   - 코드: `?sessionId=...`
   - result 페이지: `searchParams.get('session')`

### 수정 완료된 파일

#### 1. `components/workflow/ImmersiveInputForm.tsx`
- 세션 생성 → 프롬프트 생성 → 이미지 생성 → store 저장 → 결과 페이지 이동 플로우 추가
- URL 파라미터 `?session=`으로 수정

#### 2. `app/(main)/workflow/[industry]/[action]/page.tsx`
- 동일한 플로우 추가 (라인 191-243)

#### 3. `lib/imageProvider/googleGenAI.ts`
- `GOOGLE_API_KEY` fallback 추가 (라인 64)
- `responseMimeType` → `responseModalities: ['TEXT', 'IMAGE']` 변경 (라인 97-99)
- 디버그 로그 추가 (라인 104)

### 아직 해결 안 된 문제 ❌

**Google GenAI API가 이미지를 반환하지 않음**
```
Generate API error: Error [ImageGenerationError]: No images were generated
```

현재 코드는 `@google/generative-ai` 라이브러리의 `generateContent`를 사용하는데,
이미지 생성용으로 적합하지 않음.

### 다음 세션 작업 (필수)

**원본 프로젝트(`/Users/jerome/dev/FlowStudio`) 참조하여 이미지 생성 로직 교체**

#### 원본 프로젝트 핵심 파일:
1. `/Users/jerome/dev/FlowStudio/lib/imageProvider.ts` - 통합 프로바이더 레이어
2. `/Users/jerome/dev/FlowStudio/lib/openrouter.ts` - OpenRouter API 클라이언트
3. `/Users/jerome/dev/FlowStudio/lib/vertexai.ts` - Google GenAI 클라이언트 (`@google/genai` 사용)

#### 원본과 현재 차이점:
| 항목 | 원본 (FlowStudio) | 현재 (FlowStudio_re) |
|------|-------------------|---------------------|
| 패키지 | `@google/genai` | `@google/generative-ai` |
| 클라이언트 | `GoogleGenAI` | `GoogleGenerativeAI` |
| 모델 | `gemini-3-pro-image-preview` | `gemini-2.0-flash-exp-image-generation` |
| API 호출 | `ai.models.generateContent()` | `model.generateContent()` |
| 프로바이더 전략 | google/openrouter/hybrid | google only |

#### 작업 순서:
1. `@google/genai` 패키지 설치: `npm install @google/genai`
2. 원본 `lib/vertexai.ts` 복사/적용
3. 원본 `lib/openrouter.ts` 복사/적용
4. 원본 `lib/imageProvider.ts` 구조 참조하여 현재 `lib/imageProvider/` 리팩터링
5. `/api/generate/route.ts` 원본 구조 참조하여 수정

### 환경 변수 (이미 설정됨)
```
GOOGLE_API_KEY=AIzaSyACmqNvoROM8mcm5fjNyf7w2785w8_q9JU
GOOGLE_GENAI_USE_VERTEXAI=false
OPENROUTER_API_KEY=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
```

### 테스트 방법
1. 워크플로우 진입 (업종 선택 → 스타일 선택 → 입력)
2. "생성" 버튼 클릭
3. 서버 로그에서 확인:
   - `POST /api/workflows/session 201` ✅
   - `PUT /api/workflows/session 200` ✅
   - `POST /api/generate 200` ← 이것이 성공해야 함
4. 결과 페이지에서 이미지 표시 확인

## 파일 변경 요약
```
modified: components/workflow/ImmersiveInputForm.tsx (이미지 생성 플로우 추가)
modified: app/(main)/workflow/[industry]/[action]/page.tsx (이미지 생성 플로우 추가)
modified: lib/imageProvider/googleGenAI.ts (API 키 fallback, responseModalities)
```

## 다음 세션 시작 명령
```
/clear 후:
"원본 FlowStudio 프로젝트의 이미지 생성 로직을 FlowStudio_re에 적용해줘.
lib/vertexai.ts, lib/openrouter.ts, lib/imageProvider.ts 참조해서
Google AI Studio + OpenRouter 하이브리드 전략 구현"
```
