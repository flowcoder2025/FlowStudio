# 핸드오프 - 2026-02-03 (Phase 18a: Storage Quota)

## 빌드 상태
- 타입 체크: ✅ PASS
- 빌드: ✅ PASS (50 pages generated)
- 린트: ⚠️ 설정 이슈 (Phase 범위 외 - rushstack/eslint 패치 문제)

## 완료된 Phase
- Phase 18a: Storage Quota 구현 완료 (6/6 파일)

## 구현 내용

### 1. DB 스키마 변경
**파일**: `prisma/schema.prisma`
- `UserStorageStats` 모델 추가
  - `id`: String (cuid)
  - `userId`: String (unique, User relation)
  - `totalBytes`: BigInt (기본값 0)
  - `imageCount`: Int (기본값 0)
  - `updatedAt`: DateTime
- `User` 모델에 `storageStats` relation 추가

### 2. lib/storage/quota.ts (신규)
Quota 관리 함수들:
- `parseStorageString(storage)`: "1GB" → bytes 변환
- `getStorageLimitForUser(userId)`: 플랜별 한도 조회
- `getStorageUsage(userId)`: 현재 사용량 조회
- `checkStorageQuota(userId, additionalBytes)`: 업로드 전 quota 체크
- `updateStorageUsage(userId, bytesChange, countChange)`: 사용량 업데이트
- `formatStorageSize(bytes)`: 바이트를 사람이 읽기 쉬운 형태로 변환
- `getStorageStatsSummary(userId)`: 저장공간 요약 정보

플랜별 저장공간 한도:
| 플랜 | 한도 |
|------|------|
| Free | 1GB |
| Plus | 100GB |
| Pro | 500GB |
| Business | 1TB |

### 3. lib/storage/uploadImage.ts 수정
- `UploadResult`에 `errorCode` 필드 추가
- `uploadImage` 함수에 quota 체크 로직 추가:
  - 업로드 전 `checkStorageQuota()` 호출
  - 한도 초과 시 `STORAGE_QUOTA_EXCEEDED` 에러 반환
  - 업로드 성공 후 `updateStorageUsage()` 호출

### 4. lib/images/delete.ts 수정
- `ImageToDelete` 인터페이스에 `userId` 필드 추가
- `permanentDelete` 함수에서 삭제 시 `updateStorageUsage()` 호출 (감소)
- `estimateImageSize()` 함수 추가 (HEAD 요청으로 이미지 크기 추정)

### 5. app/api/images/save/route.ts 수정
- `STORAGE_QUOTA_EXCEEDED` 에러 시 402 Payment Required 응답

### 6. lib/storage/index.ts 수정
- quota 관련 함수/타입 export 추가

## 다음 작업
- DB 마이그레이션: `npx prisma migrate dev --name add_user_storage_stats`
- 기존 사용자 데이터 마이그레이션 (선택): 기존 이미지 크기 계산하여 UserStorageStats 초기화

## 테스트 방법
```bash
# 1. Prisma 클라이언트 재생성 (이미 완료)
npx prisma generate

# 2. DB 마이그레이션
npx prisma migrate dev --name add_user_storage_stats

# 3. 수동 테스트
# - Free 플랜 사용자로 이미지 업로드 → 성공
# - 1GB 초과 업로드 시도 → 402 응답 확인
```

## 미해결 이슈
- ESLint 설정 이슈: `eslint-config-next`와 현재 ESLint 버전 간 호환성 문제 (기존 이슈)
- `@next/swc` 버전 불일치 경고: 15.5.7 vs 15.5.11 (기존 이슈)

## 수정된 파일 목록
1. `prisma/schema.prisma`
2. `lib/storage/quota.ts` (신규)
3. `lib/storage/index.ts`
4. `lib/storage/uploadImage.ts`
5. `lib/images/delete.ts`
6. `app/api/images/save/route.ts`

## 필요 환경 설정
- 추가 환경 변수 없음
- 추가 의존성 없음
