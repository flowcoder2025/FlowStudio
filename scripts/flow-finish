#!/usr/bin/env bash
set -euo pipefail

#######################################
# flow-finish - DocOps 마무리 워크플로우
# Case 2: Finish 에이전트 기반
#######################################

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

#######################################
# 유틸리티 함수
#######################################

print_step() {
  local step="$1"
  local total="$2"
  local desc="$3"
  echo -e "${BLUE}[$step/$total]${NC} $desc"
}

print_success() {
  echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
  echo -e "${RED}✗${NC} $1"
}

#######################################
# 메인 워크플로우
#######################################

main() {
  local docs_only=false
  local skip_push=false
  local verify_level="strict"

  # 인자 파싱
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --docs-only)
        docs_only=true
        shift
        ;;
      --skip-push)
        skip_push=true
        shift
        ;;
      --verify-soft)
        verify_level="soft"
        shift
        ;;
      *)
        print_error "알 수 없는 옵션: $1"
        echo "사용법: flow-finish [--docs-only] [--skip-push] [--verify-soft]"
        exit 1
        ;;
    esac
  done

  echo ""
  echo -e "${BLUE}════════════════════════════════════════${NC}"
  echo -e "${BLUE}  flow-finish v$VERSION${NC}"
  echo -e "${BLUE}════════════════════════════════════════${NC}"
  echo ""

  local total_steps=7
  if [[ "$docs_only" == "true" ]]; then
    total_steps=5
    print_warning "docs-only 모드: 빌드/푸시 건너뜀"
    echo ""
  fi

  cd "$PROJECT_ROOT"

  #######################################
  # Step 1: 빌드 테스트 (docs-only면 건너뜀)
  #######################################
  if [[ "$docs_only" != "true" ]]; then
    print_step 1 $total_steps "빌드 테스트"

    if [[ -f "package.json" ]]; then
      if npm run build; then
        print_success "빌드 성공"
      else
        print_error "빌드 실패"
        echo ""
        echo "빌드 실패 시 문서만 진행하려면:"
        echo "  flow-finish --docs-only"
        exit 1
      fi
    else
      print_warning "package.json 없음 - 빌드 건너뜀"
    fi
    echo ""
  fi

  #######################################
  # Step 2: specctl snapshot
  #######################################
  local step=2
  if [[ "$docs_only" == "true" ]]; then step=1; fi

  print_step $step $total_steps "specctl snapshot"

  if [[ -f "$SCRIPT_DIR/specctl" ]]; then
    bash "$SCRIPT_DIR/specctl" snapshot
  else
    print_warning "specctl 없음 - MVP: 수동 모드"
  fi
  echo ""

  #######################################
  # Step 3: specctl update
  #######################################
  ((step++))
  print_step $step $total_steps "specctl update"

  if [[ -f "$SCRIPT_DIR/specctl" ]]; then
    bash "$SCRIPT_DIR/specctl" update
  else
    print_warning "specctl 없음 - MVP: 수동 모드"
  fi
  echo ""

  #######################################
  # Step 4: specctl verify
  #######################################
  ((step++))
  print_step $step $total_steps "specctl verify --level=$verify_level"

  if [[ -f "$SCRIPT_DIR/specctl" ]]; then
    if bash "$SCRIPT_DIR/specctl" verify --level="$verify_level" --cache; then
      print_success "검증 통과"
    else
      print_error "검증 실패"
      if [[ "$verify_level" == "strict" ]]; then
        echo ""
        echo "soft 모드로 진행하려면:"
        echo "  flow-finish --verify-soft"
        exit 1
      fi
    fi
  else
    print_warning "specctl 없음 - MVP: 수동 검증"
  fi
  echo ""

  #######################################
  # Step 5: specctl compile
  #######################################
  ((step++))
  print_step $step $total_steps "specctl compile"

  if [[ -f "$SCRIPT_DIR/specctl" ]]; then
    bash "$SCRIPT_DIR/specctl" compile
  else
    print_warning "specctl 없음 - MVP: 수동 산출물 생성"
  fi
  echo ""

  #######################################
  # Step 6: 커밋 (docs-only가 아닐 때)
  #######################################
  if [[ "$docs_only" != "true" ]]; then
    ((step++))
    print_step $step $total_steps "커밋"

    # docs 변경 확인
    if git diff --quiet docs/; then
      print_warning "docs 변경 없음 - 커밋 건너뜀"
    else
      # 자동 커밋
      git add docs/
      git commit -m "docs(spec): auto-sync [flow-finish]" || true
      print_success "docs 커밋 완료"
    fi
    echo ""

    #######################################
    # Step 7: 푸시
    #######################################
    if [[ "$skip_push" != "true" ]]; then
      ((step++))
      print_step $step $total_steps "푸시"

      # 현재 브랜치
      local branch
      branch=$(git rev-parse --abbrev-ref HEAD)

      if git push origin "$branch"; then
        print_success "푸시 완료: $branch"
      else
        print_error "푸시 실패"
        exit 1
      fi
    else
      print_warning "푸시 건너뜀 (--skip-push)"
    fi
    echo ""
  fi

  #######################################
  # 완료
  #######################################
  echo -e "${GREEN}════════════════════════════════════════${NC}"
  echo -e "${GREEN}  flow-finish 완료${NC}"
  echo -e "${GREEN}════════════════════════════════════════${NC}"
  echo ""

  # 상태 요약
  echo "다음 단계:"
  echo "  - COVERAGE_MATRIX 확인: docs/00_ssot/COVERAGE_MATRIX.md"
  echo "  - DRIFT_REPORT 확인: docs/00_ssot/DRIFT_REPORT.md"
  echo ""
}

main "$@"
