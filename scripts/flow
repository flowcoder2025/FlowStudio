#!/usr/bin/env bash
set -euo pipefail

#######################################
# DocOps CLI - v2.0
# 문서 기반 SSOT 관리 도구
#######################################

VERSION="2.0.0"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

#######################################
# 유틸리티 함수
#######################################

print_header() {
  echo -e "${BLUE}========================================${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${BLUE}========================================${NC}"
}

print_success() {
  echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
  echo -e "${RED}✗${NC} $1"
}

#######################################
# 명령어: status
#######################################

cmd_status() {
  print_header "[DocOps status] 현재 상태"

  echo -e "Version:      ${BLUE}$VERSION${NC}"
  echo ""

  # SSOT 파일 상태
  echo "SSOT 파일 상태:"
  local ssot_files=(
    "docs/00_ssot/ANCHOR.md"
    "docs/00_ssot/DOC_POLICY.md"
    "docs/00_ssot/COVERAGE_MATRIX.md"
    "docs/00_ssot/SPEC_SNAPSHOT.md"
    "docs/00_ssot/DRIFT_REPORT.md"
    "docs/00_ssot/DOC_DEBT.md"
  )

  for file in "${ssot_files[@]}"; do
    if [[ -f "$PROJECT_ROOT/$file" ]]; then
      print_success "$file"
    else
      print_warning "$file (없음)"
    fi
  done

  echo ""

  # specctl 스크립트 상태
  echo "CLI 도구 상태:"
  if [[ -f "$SCRIPT_DIR/specctl" ]]; then
    print_success "specctl"
  else
    print_warning "specctl (없음)"
  fi

  if [[ -f "$SCRIPT_DIR/flow-finish" ]]; then
    print_success "flow-finish"
  else
    print_warning "flow-finish (없음)"
  fi

  echo ""
}

#######################################
# 명령어: hooks
#######################################

cmd_hooks() {
  local subcmd="${1:-status}"

  case "$subcmd" in
    install)
      if [[ -f "$SCRIPT_DIR/setup-docops-hooks.sh" ]]; then
        bash "$SCRIPT_DIR/setup-docops-hooks.sh" install
      else
        print_error "setup-docops-hooks.sh 없음"
        exit 1
      fi
      ;;
    uninstall)
      if [[ -f "$SCRIPT_DIR/setup-docops-hooks.sh" ]]; then
        bash "$SCRIPT_DIR/setup-docops-hooks.sh" uninstall
      else
        print_error "setup-docops-hooks.sh 없음"
        exit 1
      fi
      ;;
    status)
      if [[ -f "$SCRIPT_DIR/setup-docops-hooks.sh" ]]; then
        bash "$SCRIPT_DIR/setup-docops-hooks.sh" status
      else
        print_header "[DocOps hooks status]"
        local hooks_dir="$PROJECT_ROOT/.git/hooks"

        if [[ -f "$hooks_dir/pre-push" ]]; then
          if grep -q "DocOps" "$hooks_dir/pre-push" 2>/dev/null; then
            print_success "pre-push (DocOps): 설치됨"
          else
            print_warning "pre-push: 설치됨 (DocOps 아님)"
          fi
        else
          print_warning "pre-push: 없음"
        fi
      fi
      ;;
    *)
      print_error "유효하지 않은 하위 명령: $subcmd"
      echo "사용법: ./scripts/flow hooks [install|uninstall|status]"
      exit 1
      ;;
  esac
}

#######################################
# 도움말
#######################################

show_help() {
  cat << EOF
DocOps CLI v$VERSION

사용법: ./scripts/flow <command> [options]

명령어:
  status              현재 상태 출력 (SSOT 파일, CLI 도구)
  hooks <cmd>         Git hooks 관리 (install|uninstall|status)
  help                도움말

예시:
  ./scripts/flow status
  ./scripts/flow hooks status
  ./scripts/flow hooks install

주요 워크플로우:
  Case 1 (pre-push 훅):
    ./scripts/flow hooks install

  Case 2 (flow:finish 권장):
    npm run flow:finish

specctl 직접 사용:
  ./scripts/specctl status
  ./scripts/specctl verify --level=soft
  ./scripts/specctl verify --level=strict

EOF
}

#######################################
# 메인
#######################################

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    status)
      cmd_status
      ;;
    hooks)
      cmd_hooks "${1:-status}"
      ;;
    help|--help|-h)
      show_help
      ;;
    *)
      print_error "알 수 없는 명령어: $cmd"
      show_help
      exit 1
      ;;
  esac
}

main "$@"
