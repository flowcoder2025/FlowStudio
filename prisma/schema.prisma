// =====================================================
// FlowStudio Prisma Schema
// =====================================================
// Evidence: IMPLEMENTATION_PLAN.md Phase 1, 2, 3, 4
// Contracts: AUTH_*, USER_*, CREDIT_*, PERMISSION_*, WORKFLOW_*, IMAGE_*

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =====================================================
// NextAuth Models
// Contract: AUTH_FUNC_GOOGLE_OAUTH, AUTH_FUNC_KAKAO_OAUTH
// =====================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =====================================================
// User Model
// Contract: USER_FUNC_PROFILE, USER_FUNC_BUSINESS_VERIFY, USER_FUNC_REFERRAL
// =====================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Credit - Contract: CREDIT_FUNC_BALANCE
  creditBalance Int @default(0)

  // Business - Contract: USER_FUNC_BUSINESS_VERIFY
  businessNumber   String?
  businessVerified Boolean @default(false)

  // Referral - Contract: USER_FUNC_REFERRAL
  referralCode String  @unique @default(cuid())
  referredBy   String?

  // Relations
  accounts         Account[]
  sessions         Session[]
  credits          Credit[]
  transactions     CreditTransaction[]
  imageProjects    ImageProject[]
  workflowSessions WorkflowSession[]
  subscriptions    Subscription[]
  payments         Payment[]

  @@index([email])
  @@index([referralCode])
}

// =====================================================
// Credit Models
// Contract: CREDIT_FUNC_BALANCE, CREDIT_FUNC_HOLD, CREDIT_FUNC_CAPTURE, CREDIT_FUNC_REFUND
// =====================================================

model Credit {
  id        String    @id @default(cuid())
  userId    String
  amount    Int
  source    String    // "purchase", "bonus", "referral"
  expiresAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      // negative for usage, positive for credit
  type        String   // "hold", "capture", "refund", "expire", "bonus"
  description String?
  holdId      String?  // for capture/refund reference
  status      String   @default("completed") // "pending", "completed", "cancelled"
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([holdId])
  @@index([status])
}

model CreditLedger {
  id           String   @id @default(cuid())
  userId       String
  creditId     String
  change       Int
  balanceAfter Int
  reason       String
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([creditId])
}

// =====================================================
// Permission Model (ReBAC)
// Contract: PERMISSION_FUNC_CHECK, PERMISSION_FUNC_GRANT, PERMISSION_FUNC_REVOKE
// =====================================================

model RelationTuple {
  id        String   @id @default(cuid())
  namespace String   // "image_project", "workflow_session", "system"
  objectId  String   // resource ID
  relation  String   // "owner", "editor", "viewer", "admin"
  subjectId String   // user ID
  createdAt DateTime @default(now())

  @@unique([namespace, objectId, relation, subjectId])
  @@index([subjectId, namespace, relation])
  @@index([objectId, namespace])
}

// =====================================================
// Workflow Models
// Contract: WORKFLOW_FUNC_INDUSTRIES, WORKFLOW_FUNC_SESSION
// =====================================================

model WorkflowSession {
  id        String   @id @default(cuid())
  userId    String
  industry  String   // "fashion", "food", "beauty", etc.
  action    String   // action within industry
  inputs    Json     // user inputs for the workflow
  prompt    String?  @db.Text // generated prompt
  status    String   @default("draft") // "draft", "generating", "completed", "failed"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  imageProjects ImageProject[]

  @@index([userId])
  @@index([status])
  @@index([industry])
}

// =====================================================
// Image Models
// Contract: IMAGE_FUNC_GENERATE, IMAGE_FUNC_SAVE, IMAGE_FUNC_LIST
// =====================================================

model ImageProject {
  id               String    @id @default(cuid())
  userId           String
  workflowSessionId String?
  title            String?
  prompt           String    @db.Text
  negativePrompt   String?   @db.Text
  imageUrl         String
  thumbnailUrl     String?
  provider         String?   // "google", "openrouter"
  model            String?   // specific model used
  metadata         Json?     // generation options, dimensions, etc.
  creditUsed       Int       @default(0)
  isUpscaled       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime? // soft delete

  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflowSession WorkflowSession? @relation(fields: [workflowSessionId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([workflowSessionId])
  @@index([deletedAt])
  @@index([createdAt])
}

// =====================================================
// Payment Models (LemonSqueezy)
// Contract: PAYMENT_FUNC_WEBHOOK, PAYMENT_FUNC_CHECKOUT, PAYMENT_FUNC_SUBSCRIPTION
// =====================================================

model Subscription {
  id                    String    @id @default(cuid())
  userId                String
  lemonSqueezyId        String    @unique // LemonSqueezy subscription ID
  lemonSqueezyCustomerId String?  // LemonSqueezy customer ID
  orderId               String?   // LemonSqueezy order ID
  productId             String?   // LemonSqueezy product ID
  variantId             String?   // LemonSqueezy variant ID
  status                String    // "active", "paused", "cancelled", "expired", "past_due", "unpaid"
  planName              String?   // Plan display name
  renewsAt              DateTime?
  endsAt                DateTime?
  trialEndsAt           DateTime?
  isPaused              Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([lemonSqueezyId])
}

model Payment {
  id                  String   @id @default(cuid())
  userId              String
  lemonSqueezyOrderId String   @unique // LemonSqueezy order ID
  lemonSqueezyCustomerId String? // LemonSqueezy customer ID
  productId           String?  // LemonSqueezy product ID
  variantId           String?  // LemonSqueezy variant ID
  status              String   // "pending", "paid", "refunded", "failed"
  amount              Int      // Amount in cents
  currency            String   @default("USD")
  productName         String?  // Product display name
  creditsGranted      Int      @default(0) // Credits added from this payment
  metadata            Json?    // Additional order metadata
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([lemonSqueezyOrderId])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventName   String   // "order_created", "subscription_created", etc.
  payload     Json     // Full webhook payload
  processed   Boolean  @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime @default(now())

  @@index([eventName])
  @@index([processed])
  @@index([createdAt])
}
